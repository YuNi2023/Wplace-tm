<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OneSignalãƒ‡ãƒãƒƒã‚°</title>

<!-- â˜… PWAã¨ã—ã¦èªè­˜ã•ã›ã‚‹ãŸã‚ã«å¿…é ˆ -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#111111">

<style>
  body{font-family:system-ui;-webkit-user-select:text}
  code{background:#f4f4f4;padding:.1em .3em;border-radius:4px}
</style>

<!-- v16 SDK ã‚’ç¢ºå®Ÿã«èª­ã¿è¾¼ã‚€ï¼ˆonloadãƒ•ãƒ©ã‚°ï¼‰ -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"
        async onload="window.__osLoaded=true"></script>

<script>
const APP_ID = "14fafe99-072e-475e-a1fa-6a76d3c5c695"; // â† ã‚ãªãŸã®App ID

function log(line){ const p=document.createElement('div'); p.textContent=line; document.getElementById('log').appendChild(p); }
function hr(){ document.getElementById('log').appendChild(document.createElement('hr')); }

async function waitForOS(ms=10000){
  const start=Date.now();
  return await new Promise((res,rej)=>{
    (function tick(){
      if (window.OneSignal && window.OneSignal.Notifications) return res(window.OneSignal);
      if (Date.now()-start>ms) return rej(new Error('OneSignal SDK timeout'));
      setTimeout(tick,100);
    })();
  });
}

async function checkSW(){
  if(!('serviceWorker' in navigator)){ log('âŒ ã“ã®ç’°å¢ƒã¯Service Workeréå¯¾å¿œ'); return; }
  const regs = await navigator.serviceWorker.getRegistrations();
  log(`SWç™»éŒ²æ•°: ${regs.length}`);
  regs.forEach((r,i)=>log(`- [${i}] scope=${r.scope}`));
}

async function init(){
  log(`URL: ${location.href}`);
  log(`origin: ${location.origin}`);
  log(`path: ${location.pathname}`);
  log(`iOS PWAåˆ¤å®š: ${window.navigator.standalone ? 'âœ… standalone' : 'âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–'}`);
  hr();

  await checkSW();
  hr();

  try{
    log('SDKèª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...');
    const OS = await waitForOS();
    log('âœ… SDKèª­ã¿è¾¼ã¿OK');

    log('OneSignal.init å®Ÿè¡Œ...');
    await OS.init({
      appId: APP_ID,
      notifyButton: { enable:false },
      serviceWorkerParam: { scope: './' },
      serviceWorkerPath: 'OneSignalSDKWorker.js',
      serviceWorkerUpdaterPath: 'OneSignalSDKUpdaterWorker.js'
    });
    log('âœ… OneSignal.init å®Œäº†');

    const perm = await OS.Notifications.permission;
    log(`é€šçŸ¥æ¨©é™: ${perm}`); // default|granted|denied
    document.getElementById('req').disabled = false;
  }catch(e){
    log('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+ e.message);
    log('ãƒ’ãƒ³ãƒˆ: Site URL ã¨å®ŸURLãŒå®Œå…¨ä¸€è‡´ï¼ˆæœ«å°¾/å¤§æ–‡å­—å°æ–‡å­—/ã‚µãƒ–ãƒ‘ã‚¹ï¼‰ã—ã¦ã„ã‚‹ã‹');
    log('ãƒ’ãƒ³ãƒˆ: ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰é–‹ã„ã¦ã„ã‚‹ã‹ï¼ˆä¸Šã®åˆ¤å®šãŒâœ…ã«ãªã‚‹å¿…è¦ã‚ã‚Šï¼‰');
    log('ãƒ’ãƒ³ãƒˆ: OneSignalSDKWorker.js ãŒ /repoç›´ä¸‹ ã‹ç¢ºèª');
  }
}

async function requestPerm(){
  try{
    const OS = await waitForOS();
    const before = await OS.Notifications.permission;
    log(`è¦æ±‚å‰ã®æ¨©é™: ${before}`);
    const ok = await OS.Notifications.requestPermission();
    log(ok ? 'âœ… è¨±å¯ã•ã‚Œã¾ã—ãŸ' : 'âš ï¸ è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
  }catch(e){
    log('âŒ requestPermission ã‚¨ãƒ©ãƒ¼: '+e.message);
  }
}

window.addEventListener('load', init);
</script>
</head>
<body>
<h1>OneSignal ãƒ‡ãƒãƒƒã‚°</h1>
<p>æ‰‹é †ï¼šã“ã®ãƒšãƒ¼ã‚¸ã‚’ <b>Safariã§é–‹ã â†’ å…±æœ‰ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </b>ã—ã€<b>ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰é–‹ã</b>ã€‚</p>
<p><button id="req" onclick="requestPerm()" disabled>ğŸ”” é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button></p>
<pre id="log" style="white-space:pre-wrap"></pre>
</body>
</html>
