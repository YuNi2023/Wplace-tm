<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OneSignalデバッグ</title>

<!-- ★ PWAとして認識させるために必須 -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#111111">

<style>
  body{font-family:system-ui;-webkit-user-select:text}
  code{background:#f4f4f4;padding:.1em .3em;border-radius:4px}
</style>

<!-- v16 SDK を確実に読み込む（onloadフラグ） -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"
        async onload="window.__osLoaded=true"></script>

<script>
const APP_ID = "14fafe99-072e-475e-a1fa-6a76d3c5c695"; // ← あなたのApp ID

function log(line){ const p=document.createElement('div'); p.textContent=line; document.getElementById('log').appendChild(p); }
function hr(){ document.getElementById('log').appendChild(document.createElement('hr')); }

async function waitForOS(ms=10000){
  const start=Date.now();
  return await new Promise((res,rej)=>{
    (function tick(){
      if (window.OneSignal && window.OneSignal.Notifications) return res(window.OneSignal);
      if (Date.now()-start>ms) return rej(new Error('OneSignal SDK timeout'));
      setTimeout(tick,100);
    })();
  });
}

async function checkSW(){
  if(!('serviceWorker' in navigator)){ log('❌ この環境はService Worker非対応'); return; }
  const regs = await navigator.serviceWorker.getRegistrations();
  log(`SW登録数: ${regs.length}`);
  regs.forEach((r,i)=>log(`- [${i}] scope=${r.scope}`));
}

async function init(){
  log(`URL: ${location.href}`);
  log(`origin: ${location.origin}`);
  log(`path: ${location.pathname}`);
  log(`iOS PWA判定: ${window.navigator.standalone ? '✅ standalone' : '⚠️ ブラウザタブ'}`);
  hr();

  await checkSW();
  hr();

  try{
    log('SDK読み込み待機中...');
    const OS = await waitForOS();
    log('✅ SDK読み込みOK');

    log('OneSignal.init 実行...');
    await OS.init({
      appId: APP_ID,
      notifyButton: { enable:false },
      serviceWorkerParam: { scope: './' },
      serviceWorkerPath: 'OneSignalSDKWorker.js',
      serviceWorkerUpdaterPath: 'OneSignalSDKUpdaterWorker.js'
    });
    log('✅ OneSignal.init 完了');

    const perm = await OS.Notifications.permission;
    log(`通知権限: ${perm}`); // default|granted|denied
    document.getElementById('req').disabled = false;
  }catch(e){
    log('❌ 初期化エラー: '+ e.message);
    log('ヒント: Site URL と実URLが完全一致（末尾/大文字小文字/サブパス）しているか');
    log('ヒント: ホーム画面アイコンから開いているか（上の判定が✅になる必要あり）');
    log('ヒント: OneSignalSDKWorker.js が /repo直下 か確認');
  }
}

async function requestPerm(){
  try{
    const OS = await waitForOS();
    const before = await OS.Notifications.permission;
    log(`要求前の権限: ${before}`);
    const ok = await OS.Notifications.requestPermission();
    log(ok ? '✅ 許可されました' : '⚠️ 許可されませんでした');
  }catch(e){
    log('❌ requestPermission エラー: '+e.message);
  }
}

window.addEventListener('load', init);
</script>
</head>
<body>
<h1>OneSignal デバッグ</h1>
<p>手順：このページを <b>Safariで開く → 共有 → ホーム画面に追加</b>し、<b>アイコンから開く</b>。</p>
<p><button id="req" onclick="requestPerm()" disabled>🔔 通知許可をリクエスト</button></p>
<pre id="log" style="white-space:pre-wrap"></pre>
</body>
</html>
