<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#111111"/>
  <title>Wplace アカウント管理 & 通知</title>

  <!-- OneSignal SDK（onloadフラグ付き） -->
  <script
    src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"
    async
    onload="window.__osLoaded=true">
  </script>

  <script>
    // OneSignalの初期化完了まで待つユーティリティ（最大10秒リトライ）
    function waitForOneSignalReady(timeoutMs = 10000) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function tick(){
          const os = window.OneSignal;
          if (os && os.Notifications) return resolve(os);
          if (Date.now() - start > timeoutMs) return reject(new Error('OneSignal init timeout'));
          setTimeout(tick, 100);
        })();
      });
    }

    // SDK初期化：PWA起動直後に走る
    (async function initOS() {
      try {
        await waitForOneSignalReady(); // SDKロード待ち
        await window.OneSignal.init({
          appId: "14fafe99-072e-475e-a1fa-6a76d3c5c695",
          notifyButton: { enable: false },
          // iOS含めSWを確実に使う（ルートに置いた2ファイルを読む）
          serviceWorkerParam: { scope: './' },
          serviceWorkerPath: 'OneSignalSDKWorker.js',
          serviceWorkerUpdaterPath: 'OneSignalSDKUpdaterWorker.js'
        });
        console.log('OneSignal initialized');
      } catch (e) {
        console.error('OneSignal init failed', e);
      }
    })();

    // クリックで通知許可をリクエスト（iOSはユーザー操作が確実）
    async function requestPushPermission() {
      try {
        const OneSignal = await waitForOneSignalReady();
        const permBefore = await OneSignal.Notifications.permission; // default|granted|denied
        console.log('before:', permBefore);
        const granted = await OneSignal.Notifications.requestPermission();
        alert(granted ? "通知が許可されました！" : "通知は許可されませんでした。");
      } catch (e) {
        console.error(e);
        alert("OneSignalの初期化中です。数秒後に再試行してください。");
      }
    }
  </script>
</head>
<body>
  <h1>Wplace アカウント管理</h1>

  <!-- 通知許可ボタン（ここを押すと確実にダイアログが出ます） -->
  <p><button onclick="requestPushPermission()">🔔 通知を有効化</button></p>

  <form id="accountForm">
    <label>メール: <input required name="email" type="email"></label><br>
    <label>アカウント名: <input required name="name" type="text"></label><br>
    <label>Level(例: Level2 (14%)): <input name="level" type="text"></label><br>
    <label>Droplets: <input required name="droplets" type="number" min="0"></label><br>
    <label>Paint上限(cap): <input required name="cap" type="number" min="1"></label><br>
    <label>現在Paint(cur): <input required name="cur" type="number" min="0" step="1"></label><br><br>

    <fieldset>
      <legend>通知設定（このアカウント）</legend>
      <label><input type="checkbox" name="notif_full"> 全回復時</label><br>
      <label>全回復○分前: <input name="notif_full_minutes_before" type="number" min="1" placeholder="例: 10"></label><br>
      <label>全回復○%前: <input name="notif_full_percent_before" type="number" min="1" max="99" placeholder="例: 10"></label><br>
      <label>指定Paintに到達: <input name="notif_target_paint" type="number" min="0" placeholder="例: 1000"></label><br>
    </fieldset>
    <button type="submit">登録/更新</button>
  </form>

  <hr>
  <h2>登録済みアカウント</h2>
  <ul id="list"></ul>

  <!-- 既存のアプリロジック -->
  <script src="app.js"></script>
</body>
</html>
