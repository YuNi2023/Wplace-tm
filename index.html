<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#111111"/>
  <title>Wplace ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç† & é€šçŸ¥</title>

  <!-- OneSignal SDKï¼ˆonloadãƒ•ãƒ©ã‚°ä»˜ãï¼‰ -->
  <script
    src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"
    async
    onload="window.__osLoaded=true">
  </script>

  <script>
    // OneSignalã®åˆæœŸåŒ–å®Œäº†ã¾ã§å¾…ã¤ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆæœ€å¤§10ç§’ãƒªãƒˆãƒ©ã‚¤ï¼‰
    function waitForOneSignalReady(timeoutMs = 10000) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function tick(){
          const os = window.OneSignal;
          if (os && os.Notifications) return resolve(os);
          if (Date.now() - start > timeoutMs) return reject(new Error('OneSignal init timeout'));
          setTimeout(tick, 100);
        })();
      });
    }

    // SDKåˆæœŸåŒ–ï¼šPWAèµ·å‹•ç›´å¾Œã«èµ°ã‚‹
    (async function initOS() {
      try {
        await waitForOneSignalReady(); // SDKãƒ­ãƒ¼ãƒ‰å¾…ã¡
        await window.OneSignal.init({
          appId: "14fafe99-072e-475e-a1fa-6a76d3c5c695",
          notifyButton: { enable: false },
          // iOSå«ã‚SWã‚’ç¢ºå®Ÿã«ä½¿ã†ï¼ˆãƒ«ãƒ¼ãƒˆã«ç½®ã„ãŸ2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚€ï¼‰
          serviceWorkerParam: { scope: './' },
          serviceWorkerPath: 'OneSignalSDKWorker.js',
          serviceWorkerUpdaterPath: 'OneSignalSDKUpdaterWorker.js'
        });
        console.log('OneSignal initialized');
      } catch (e) {
        console.error('OneSignal init failed', e);
      }
    })();

    // ã‚¯ãƒªãƒƒã‚¯ã§é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆiOSã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒç¢ºå®Ÿï¼‰
    async function requestPushPermission() {
      try {
        const OneSignal = await waitForOneSignalReady();
        const permBefore = await OneSignal.Notifications.permission; // default|granted|denied
        console.log('before:', permBefore);
        const granted = await OneSignal.Notifications.requestPermission();
        alert(granted ? "é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼" : "é€šçŸ¥ã¯è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
      } catch (e) {
        console.error(e);
        alert("OneSignalã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚æ•°ç§’å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
      }
    }
  </script>
</head>
<body>
  <h1>Wplace ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</h1>

  <!-- é€šçŸ¥è¨±å¯ãƒœã‚¿ãƒ³ï¼ˆã“ã“ã‚’æŠ¼ã™ã¨ç¢ºå®Ÿã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºã¾ã™ï¼‰ -->
  <p><button onclick="requestPushPermission()">ğŸ”” é€šçŸ¥ã‚’æœ‰åŠ¹åŒ–</button></p>

  <form id="accountForm">
    <label>ãƒ¡ãƒ¼ãƒ«: <input required name="email" type="email"></label><br>
    <label>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå: <input required name="name" type="text"></label><br>
    <label>Level(ä¾‹: Level2 (14%)): <input name="level" type="text"></label><br>
    <label>Droplets: <input required name="droplets" type="number" min="0"></label><br>
    <label>Paintä¸Šé™(cap): <input required name="cap" type="number" min="1"></label><br>
    <label>ç¾åœ¨Paint(cur): <input required name="cur" type="number" min="0" step="1"></label><br><br>

    <fieldset>
      <legend>é€šçŸ¥è¨­å®šï¼ˆã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰</legend>
      <label><input type="checkbox" name="notif_full"> å…¨å›å¾©æ™‚</label><br>
      <label>å…¨å›å¾©â—‹åˆ†å‰: <input name="notif_full_minutes_before" type="number" min="1" placeholder="ä¾‹: 10"></label><br>
      <label>å…¨å›å¾©â—‹%å‰: <input name="notif_full_percent_before" type="number" min="1" max="99" placeholder="ä¾‹: 10"></label><br>
      <label>æŒ‡å®šPaintã«åˆ°é”: <input name="notif_target_paint" type="number" min="0" placeholder="ä¾‹: 1000"></label><br>
    </fieldset>
    <button type="submit">ç™»éŒ²/æ›´æ–°</button>
  </form>

  <hr>
  <h2>ç™»éŒ²æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h2>
  <ul id="list"></ul>

  <!-- æ—¢å­˜ã®ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ -->
  <script src="app.js"></script>
</body>
</html>
